apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: bootstrap-namespace
spec:
  admission: true
  background: true
  emitWarning: false
  rules:
  - generate:
      apiVersion: rbac.authorization.k8s.io/v1
      data:
        roleRef:
          apiGroup: rbac.authorization.k8s.io
          kind: ClusterRole
          name: tenant-admin-actions
        subjects:
        - apiGroup: rbac.authorization.k8s.io
          kind: User
          name: '{{ request.object.metadata.annotations.username }}'
      kind: RoleBinding
      name: tenant-admin-actions-{{ request.object.metadata.annotations.username }}
      namespace: '{{ request.object.metadata.name }}'
      synchronize: true
    match:
      any:
      - resources:
          kinds:
          - Namespace
          operations:
          - CREATE
    name: give-admin-permissions
    preconditions:
      all:
      - key: '{{ request.object.metadata.annotations.username_hash || '''' }}'
        operator: NotEquals
        value: ""
    skipBackgroundRequests: true
  validationFailureAction: Audit